<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Accent Conversion</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .transcript-box, .status-box {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            background-color: #fff;
            min-height: 100px;
        }
        .transcript-box {
            min-height: 150px;
        }
        .status {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .interim {
            color: #7f8c8d;
            font-style: italic;
        }
        .final {
            color: #2c3e50;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .audio-player {
            width: 100%;
            margin-top: 10px;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
            color: #3498db;
            font-weight: bold;
        }
        .indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .inactive {
            background-color: #e74c3c;
        }
        .active {
            background-color: #2ecc71;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Real-time Accent Conversion</h1>
        <p>This demo converts Indian English accent to British English accent in real-time.</p>
        
        <div class="controls">
            <button id="startButton">Start Recording</button>
            <button id="stopButton" disabled>Stop Recording</button>
        </div>

        <div class="status-box">
            <div class="status">Status: <span id="statusText">Not connected</span></div>
            <div>
                Recording: <span class="indicator inactive" id="recordingIndicator"></span>
                <span id="recordingStatus">Inactive</span>
            </div>
            <div id="errorContainer" class="error" style="display: none;"></div>
        </div>
        
        <h3>Transcription (Indian English)</h3>
        <div class="transcript-box" id="transcriptContainer"></div>
        
        <h3>Converted Speech (British English)</h3>
        <audio id="audioPlayer" controls class="audio-player"></audio>
    </div>

    <script>
        (() => {
            // DOM elements
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const statusText = document.getElementById('statusText');
            const recordingIndicator = document.getElementById('recordingIndicator');
            const recordingStatus = document.getElementById('recordingStatus');
            const transcriptContainer = document.getElementById('transcriptContainer');
            const audioPlayer = document.getElementById('audioPlayer');
            const errorContainer = document.getElementById('errorContainer');

            // Socket.io connection
            const socket = io();
            
            // Audio recording variables
            let mediaRecorder;
            let audioContext;
            let recordingInterval;
            let isRecording = false;
            
            // Connect to socket
            socket.on('connect', () => {
                setStatus('Connected to server');
            });
            
            socket.on('disconnect', () => {
                setStatus('Disconnected from server');
                stopRecording();
            });
            
            // Handle streaming ready event
            socket.on('streamingReady', () => {
                setStatus('Streaming ready - speak now');
                startRecording();
            });
            
            // Handle transcript updates
            socket.on('transcript', (data) => {
                if (data.isFinal) {
                    updateTranscript(`<div class="final">${data.text}</div>`);
                } else {
                    updateTranscript(`<div class="interim">${data.text}</div>`);
                }
            });
            
            // Handle audio results
            socket.on('audioResult', (data) => {
                playAudio(data.audio);
            });
            
            // Handle errors
            socket.on('error', (error) => {
                showError(`Error: ${error.message} - ${error.details}`);
                stopRecording();
            });
            
            // Start button click handler
            startButton.addEventListener('click', () => {
                // Reset UI
                setStatus('Initializing stream...');
                clearTranscript();
                hideError();
                
                // Request microphone access
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(handleMicrophoneStream)
                        .catch(handleMicrophoneError);
                } else {
                    showError('Your browser does not support microphone access');
                }
            });
            
            // Stop button click handler
            stopButton.addEventListener('click', () => {
                stopRecording();
                socket.emit('stopStreaming');
                setStatus('Streaming stopped');
            });
            
            // Handle microphone stream
            function handleMicrophoneStream(stream) {
                // Start streaming session
                socket.emit('startStreaming');
                
                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create media recorder
                const options = { 
                    mimeType: 'audio/webm',
                    audioBitsPerSecond: 16000
                };
                
                try {
                    mediaRecorder = new MediaRecorder(stream, options);
                } catch (e) {
                    mediaRecorder = new MediaRecorder(stream);
                }
                
                // Set up recorder event handlers
                mediaRecorder.ondataavailable = handleAudioData;
            }
            
            // Handle microphone access error
            function handleMicrophoneError(error) {
                showError(`Microphone access error: ${error.message}`);
                setStatus('Failed to access microphone');
            }
            
            // Handle audio data from recorder
            function handleAudioData(event) {
                if (event.data.size > 0 && socket.connected) {
                    // Convert blob to base64
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64data = reader.result.split(',')[1];
                        // Send audio data to server
                        socket.emit('audioData', { audio: base64data });
                    };
                    reader.readAsDataURL(event.data);
                }
            }
            
            // Start recording from microphone
            function startRecording() {
                if (!mediaRecorder) return;
                
                // Start recording
                mediaRecorder.start(500); // Collect data every 500ms
                
                // Update UI
                isRecording = true;
                startButton.disabled = true;
                stopButton.disabled = false;
                recordingIndicator.classList.remove('inactive');
                recordingIndicator.classList.add('active');
                recordingStatus.textContent = 'Active';
            }
            
            // Stop recording
            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                }
                
                // Stop all audio tracks
                if (mediaRecorder && mediaRecorder.stream) {
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
                
                // Update UI
                startButton.disabled = false;
                stopButton.disabled = true;
                recordingIndicator.classList.remove('active');
                recordingIndicator.classList.add('inactive');
                recordingStatus.textContent = 'Inactive';
            }
            
            // Play audio from base64 string
            function playAudio(base64Audio) {
                const audioData = 'data:audio/mp3;base64,' + base64Audio;
                audioPlayer.src = audioData;
                audioPlayer.play().catch(err => console.error('Audio playback error:', err));
            }
            
            // Helper functions for UI updates
            function setStatus(message) {
                statusText.textContent = message;
            }
            
            function updateTranscript(html) {
                transcriptContainer.innerHTML = html;
            }
            
            function clearTranscript() {
                transcriptContainer.innerHTML = '';
            }
            
            function showError(message) {
                errorContainer.textContent = message;
                errorContainer.style.display = 'block';
            }
            
            function hideError() {
                errorContainer.style.display = 'none';
            }
        })();
    </script>
</body>
</html> 